<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Asignar Boletos - Sistema de Gestión</title>

    <link rel="stylesheet" href="../../css/variables.css">
    <link rel="stylesheet" href="../../css/main.css">
    <link rel="stylesheet" href="../../css/components.css">

    <style>
        .asignar-container {
            max-width: 900px;
            margin: 40px auto;
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 2px 16px #0002;
            padding: 2rem;
        }
        .section-title { text-align: center; margin-bottom: 1.5rem; }
        .detalle-evento, .detalle-seleccion, .informacion-adicional {
            margin-bottom: 2rem;
        }
        .detalle-evento h3, .detalle-seleccion h3, .informacion-adicional h3 {
            margin-bottom: 1rem;
        }
        label { display: block; margin: 0.5rem 0; font-weight: 500; }
        input { width: 100%; padding: 0.5rem; margin-top: 0.2rem; box-sizing: border-box; }
        .btn-container { text-align: center; margin-top: 2rem; }
    </style>
</head>
<body class="has-navbar">
    <div id="navbar-container"></div>

    <main>
        <div class="asignar-container">
            <h2 class="section-title">Asignar Boletos</h2>

            <!-- Detalles del evento -->
            <div class="detalle-evento" id="detalleEvento"></div>

            <!-- Detalles de selección del usuario -->
            <div class="detalle-seleccion" id="detalleSeleccion"></div>

            <!-- Información adicional para crear registro -->
            <div class="informacion-adicional">
                <h3>Información Adicional para Crear Registro</h3>
                <label>
                    Nombre del Cliente:
                    <input type="text" id="clienteNombre">
                </label>
                <label>
                    Correo del Cliente:
                    <input type="email" id="clienteCorreo">
                </label>
                <label>
                    Cédula:
                    <input type="text" id="clienteCedula" maxlength="10" pattern="\d*" title="Solo números, máximo 10 dígitos">
                </label>
                <label>
                    Teléfono:
                    <input type="text" id="clienteTelefono" maxlength="10" pattern="\d*" title="Solo números, máximo 10 dígitos">
                </label>
            </div>

            <div class="btn-container">
                <button id="btnGuardar" class="btn btn-primary">Guardar Boletos</button>
            </div>
        </div>
    </main>

    <div id="footer-container"></div>

    <script type="module">
        // Importando módulos
        import stateManager from '../../js/state-manager.js';
        import enviarABaseDeDatos from './asignarBoletos.js';

        const detalleEventoDiv = document.getElementById('detalleEvento');
        const detalleSeleccionDiv = document.getElementById('detalleSeleccion');
        const btnGuardar = document.getElementById('btnGuardar');

        const evento = stateManager.getSelectedEvent();
        const seleccion = stateManager.getSessionData('selectedTickets');

        // Mostrar evento
        if (evento) {
            detalleEventoDiv.innerHTML = `
                <h3>${evento.evt_nombre}</h3>
                <p><strong>Dirección:</strong> ${evento.evt_direccion}</p>
                <p><strong>Fecha Inicio:</strong> ${new Date(evento.evt_fechainicio).toLocaleString()}</p>
                <p><strong>Fecha Fin:</strong> ${new Date(evento.evt_fechafin).toLocaleString()}</p>
                <p><strong>Precio Base General:</strong> $${evento.evt_preciobasegeneral.toFixed(2)}</p>
            `;
        } else detalleEventoDiv.innerHTML = '<p>No hay evento seleccionado.</p>';

        // Mostrar selección
        if (seleccion) {
            detalleSeleccionDiv.innerHTML = `
                <h3>Selección del Usuario</h3>
                <p><strong>Sección:</strong> ${seleccion.seccion}</p>
                <p><strong>Tipo de Boleto:</strong> ${seleccion.tipo}</p>
                <p><strong>Cantidad:</strong> ${seleccion.cantidad}</p>
                <p><strong>Precio Total:</strong> $${seleccion.precioTotal.toFixed(2)}</p>
            `;
        } else detalleSeleccionDiv.innerHTML = '<p>No hay selección de boletos.</p>';

        // Validación de cédula y teléfono
        document.getElementById('clienteCedula').addEventListener('input', e => {
            e.target.value = e.target.value.replace(/\D/g, '').slice(0,10);
        });
        document.getElementById('clienteTelefono').addEventListener('input', e => {
            e.target.value = e.target.value.replace(/\D/g, '').slice(0,10);
        });

        btnGuardar.addEventListener('click', async () => {
            const cliente = {
                nombre: document.getElementById('clienteNombre').value,
                correo: document.getElementById('clienteCorreo').value,
                cedula: document.getElementById('clienteCedula').value,
                telefono: document.getElementById('clienteTelefono').value
            };

            if (!cliente.nombre || !cliente.correo || !cliente.cedula || !cliente.telefono) {
                alert('Por favor completa todos los campos.');
                return;
            }

            const datosFinales = { cliente, evento, seleccion };

            // Obtener usuario actual
            const usuarioActual = stateManager.getCurrentUser();

            // Enviar a Supabase
            const resultado = await enviarABaseDeDatos(datosFinales, usuarioActual);
            alert(resultado.mensaje);
        });
    </script>

    <script type="module" src="../../js/navbar.js"></script>
</body>
</html>