<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clientes - Sistema de Gestión de Eventos</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="/assets/css/styles.css">
    <link rel="stylesheet" href="/assets/css/responsive.css">
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container-fluid">
            <a class="navbar-brand" href="/"><i class="bi bi-calendar-event"></i> Sistema de Gestión de Eventos</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item"><a class="nav-link" href="/">Inicio</a></li>
                    <li class="nav-item"><a class="nav-link active" href="/pages/clientes/index.html">Clientes</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container my-5">
        <!-- Breadcrumb -->
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="/">Inicio</a></li>
                <li class="breadcrumb-item active">Clientes</li>
            </ol>
        </nav>

        <!-- Header -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1><i class="bi bi-people"></i> Gestión de Clientes</h1>
            <a href="/pages/clientes/crear.html" class="btn btn-success">
                <i class="bi bi-plus-circle"></i> Nuevo Cliente
            </a>
        </div>

        <!-- Search and Export -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="input-group">
                    <input type="text" class="form-control" id="searchInput" placeholder="Buscar cliente...">
                    <button class="btn btn-primary" onclick="searchClientes()">
                        <i class="bi bi-search"></i> Buscar
                    </button>
                </div>
            </div>
            <div class="col-md-6 text-end">
                <div class="export-buttons">
                    <button class="btn btn-outline-danger" onclick="exportarClientes('pdf')">
                        <i class="bi bi-file-pdf"></i> PDF
                    </button>
                    <button class="btn btn-outline-success" onclick="exportarClientes('excel')">
                        <i class="bi bi-file-excel"></i> Excel
                    </button>
                    <button class="btn btn-outline-info" onclick="exportarClientes('csv')">
                        <i class="bi bi-file-text"></i> CSV
                    </button>
                </div>
            </div>
        </div>

        <!-- Alert Container -->
        <div id="alertContainer"></div>

        <!-- Table -->
        <div class="table-container">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Nombre</th>
                        <th>Email</th>
                        <th>Celular</th>
                        <th>Tipo</th>
                        <th>Estado</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody id="clientesTableBody">
                    <tr>
                        <td colspan="7" class="text-center">Cargando...</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- Pagination -->
        <div id="paginationContainer"></div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/assets/js/api-client.js"></script>
    <script src="/assets/js/utils.js"></script>
    <script src="/assets/js/main.js"></script>
    <script>
        let currentPage = 1;
        const limit = 10;

        // Cargar clientes al iniciar
        document.addEventListener('DOMContentLoaded', () => {
            cargarClientes();
        });

        // Cargar clientes
        async function cargarClientes(page = 1) {
            try {
                utils.showLoading();
                const params = { page, limit };

                const searchValue = document.getElementById('searchInput').value;
                if (searchValue) params.search = searchValue;

                const response = await ClientesAPI.getAll(params);
                mostrarClientes(response.data);

                if (response.metadata) {
                    utils.createPagination(
                        'paginationContainer',
                        response.metadata.page,
                        response.metadata.totalPages,
                        cargarClientes
                    );
                }

                currentPage = page;
            } catch (error) {
                utils.showAlert('Error al cargar clientes: ' + error.message, 'danger');
            } finally {
                utils.hideLoading();
            }
        }

        // Mostrar clientes en la tabla
        function mostrarClientes(clientes) {
            const tbody = document.getElementById('clientesTableBody');

            if (!clientes || clientes.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center">No hay clientes registrados</td></tr>';
                return;
            }

            tbody.innerHTML = clientes.map(cliente => `
                <tr>
                    <td>${cliente.id_Clientes}</td>
                    <td>${cliente.Cli_Nombre} ${cliente.Cli_Apellido}</td>
                    <td>${cliente.Cli_Email}</td>
                    <td>${cliente.Cli_Celular}</td>
                    <td>${cliente.TipoCliente_Nombre || 'N/A'}</td>
                    <td><span class="badge bg-success">${cliente.Cli_Estado}</span></td>
                    <td class="action-buttons">
                        <button class="btn btn-sm btn-info" onclick="verCliente(${cliente.id_Clientes})">
                            <i class="bi bi-eye"></i>
                        </button>
                        <button class="btn btn-sm btn-warning" onclick="editarCliente(${cliente.id_Clientes})">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="eliminarCliente(${cliente.id_Clientes})">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        // Buscar clientes
        function searchClientes() {
            cargarClientes(1);
        }

        // Exportar clientes
        async function exportarClientes(format) {
            try {
                utils.showLoading();
                await ClientesAPI.export(format, {});
                utils.showAlert('Datos exportados exitosamente', 'success');
            } catch (error) {
                utils.showAlert('Error al exportar: ' + error.message, 'danger');
            } finally {
                utils.hideLoading();
            }
        }

        // Ver cliente
        function verCliente(id) {
            window.location.href = `/pages/clientes/editar.html?id=${id}&readonly=true`;
        }

        // Editar cliente
        function editarCliente(id) {
            window.location.href = `/pages/clientes/editar.html?id=${id}`;
        }

        // Eliminar cliente
        async function eliminarCliente(id) {
            if (!confirm('¿Está seguro de eliminar este cliente?')) return;

            try {
                utils.showLoading();
                await ClientesAPI.delete(id);
                utils.showAlert('Cliente eliminado exitosamente', 'success');
                cargarClientes(currentPage);
            } catch (error) {
                utils.showAlert('Error al eliminar: ' + error.message, 'danger');
            } finally {
                utils.hideLoading();
            }
        }

        // Búsqueda en tiempo real (debounced)
        document.getElementById('searchInput')?.addEventListener('input',
            app.debounce(() => searchClientes(), 500)
        );
    </script>
</body>
</html>
